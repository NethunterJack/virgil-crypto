<!doctype html>
<html>
    <head>
        <title>VirgilCrypto browser test</title>
        <script src="@WRAPPER_TARGET@.js"></script>
    </head>
    <body>
    <script type="text/javascript">
        function test_encryption(lib) {
            console.time("encryption/decryption");
            var pwd = lib.VirgilByteArray.fromUTF8("password");
            var keys = lib.VirgilKeyPair.generateRecommended(pwd);
            var certId = lib.VirgilByteArray.fromUTF8("17648c7e-9ca3-4707-bdc6-a5c57b7a18fc");
            var data = lib.VirgilByteArray.fromUTF8("data to be encrypted");
            var cipher = new lib.VirgilCipher();
            cipher.addKeyRecipient(certId, keys.publicKey());
            var encryptedData = cipher.encrypt(data, true);
            var decryptedData = cipher.decryptWithKey(encryptedData, certId, keys.privateKey(), pwd);
            console.log(decryptedData.toUTF8());
            pwd.delete();
            keys.delete();
            certId.delete();
            data.delete();
            cipher.delete();
            encryptedData.delete();
            decryptedData.delete();
            console.timeEnd("encryption/decryption");
        };
        function test_stream_encryption(lib) {
            console.time("stream encryption/decryption");
            var pwd = lib.VirgilByteArray.fromUTF8("password");
            var keys = lib.VirgilKeyPair.generateRecommended(pwd);
            var certId = lib.VirgilByteArray.fromUTF8("17648c7e-9ca3-4707-bdc6-a5c57b7a18fc");
            var data = lib.VirgilByteArray.fromUTF8("data to be encrypted");
            var cipher = new lib.VirgilStreamCipher();
            cipher.addKeyRecipient(certId, keys.publicKey());

            var dataSource = new lib.VirgilStreamDataSource(data.toUint8Array(), 1);
            var dataSink = new lib.VirgilStreamDataSink();
            cipher.encrypt(dataSource, dataSink, true);

            var encrypedDataSource = new lib.VirgilStreamDataSource(dataSink.getBytes(), 2);
            var decryptedDataSink = new lib.VirgilStreamDataSink();

            cipher.decryptWithKey(encrypedDataSource, decryptedDataSink, certId, keys.privateKey(), pwd);

            var decryptedData = lib.VirgilByteArray.fromUint8Array(decryptedDataSink.getBytes());

            console.log(decryptedData.toUTF8());
            pwd.delete();
            keys.delete();
            certId.delete();
            data.delete();
            cipher.delete();
            decryptedData.delete();
            dataSource.delete();
            dataSink.delete();
            encrypedDataSource.delete();
            decryptedDataSink.delete();
            console.timeEnd("stream encryption/decryption");
        };
        function test_sign(lib) {
            console.time("sign/verify");
            var pwd = lib.VirgilByteArray.fromUTF8("");
            var keys = lib.VirgilKeyPair.generateRecommended(pwd);
            var data = lib.VirgilByteArray.fromUTF8("data to be signed");
            var signer = new lib.VirgilSigner();
            var sign = signer.sign(data, keys.privateKey(), pwd);
            var verified = signer.verify(data, sign, keys.publicKey());
            console.log("Data verification " + (verified ? "passed" : "failed"));
            pwd.delete();
            keys.delete();
            data.delete();
            signer.delete();
            sign.delete();
            console.timeEnd("sign/verify");
        };

        function runTests(instance) {
            console.log('Starting tests');

            test_encryption(instance);
            test_stream_encryption(instance);
            test_sign(instance);
        }

        __virgilCrypto().then(function (instance) {
            console.log(instance.VirgilVersion.asString());
            runTests(instance);
        });
    </script>
    </body>
</html>
